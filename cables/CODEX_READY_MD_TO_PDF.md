# Codex-Ready: Markdown -> (sanitize + parse) -> LaTeX -> Cable PDF

This repo already implements a strict, deterministic Cables pipeline under `cables/`.

The PDF path is:

`cables/content/*.md` -> `cables/tools/lint_cable.py` -> `cables/tools/build_cable.py` -> `cables/templates/cable.tex` -> `cables/build/pdf/*.pdf`

## Strict rules (hard fail)

Build aborts if any of the following are true:

- Cable Markdown contains raw HTML tags.
- Any non-ASCII character appears in cable Markdown.
- Any required section is missing or out of order: `SUMMARY`, `FACTS`, `ASSESSMENT`, `OUTLOOK`.
- The MicroCode line is missing a field, wraps to multiple lines, or contains malformed/unsafe values.
- UTC timestamp is not Zulu (`YYYY-MM-DDTHH:MMZ`).

## Authoritative tree (within this repo)

```
cables/
  content/                 # input Markdown
  templates/
    cable.tex              # LaTeX print artifact template
  tools/
    lint_cable.py          # strict sanitizer + structure rules
    build_cable.py         # Markdown -> LaTeX -> PDF (also HTML/feed/index/bundles)
    md2latex.py            # small deterministic sanitizer/helpers
    aztec.py               # real Aztec code encoder (PNG)
  build/
    pdf/                   # output PDFs (+ bundles)
```

## Markdown format (strict)

Each cable is a single ASCII-only Markdown file with minimal frontmatter and four required sections.

Example: `cables/content/2025/12/20/mspm-cbl-2025-12-20-001.md`

```
---
cable_id: MSPM-CBL-2025-12-20-001
utc: 2025-12-20T14:30Z
title: Example Cable - Template Validation
sig: ED25519-MSPM-Q4D9Z3W1KP7H8C
---

## SUMMARY
One short paragraph.

## FACTS
- Bullet facts only.

## ASSESSMENT
One short paragraph.

## OUTLOOK
One short paragraph.
```

Notes:

- No raw HTML (e.g., `<div>...</div>`).
- ASCII only (no Unicode punctuation).
- No fenced code blocks.

## Deterministic hash + MicroCode

The build computes a SHA-256 over canonical text derived from the source (metadata + the four sections), then emits a single MicroCode line:

```
<CABLE-ID> | UTC:<ISO8601Z> | SHA256:<64HEX> | SIG:<ALG>-<KEYID>
```

The delimiter is ` | ` (ASCII) to keep strict ASCII guarantees.

## Delineation markers

The rendered outputs include explicit ASCII markers (centered) to delineate content vs. verification:

- `START CABLE` / `END CABLE`
- `START VERIFICATION` / `END VERIFICATION`

These markers are for human/OCR boundary clarity and are not included in the SHA-256 canonical text.

## Aztec anchor

The PDF embeds a real Aztec code after the MicroCode line, pointing at the canonical URL with a short hash fragment:

```
https://www.mspmetro.com/cables/<CABLE-ID>#sha256=<first16hex>
```

The Aztec image is generated by `cables/tools/aztec.py` and included in the PDF via `\includegraphics{...}`.

The label under the Aztec is the Cable ID (no extra caption).

## Build commands

Install Python deps (for Aztec generation):

- `make -C cables setup`

Lint all cable Markdown:

- `make -C cables lint`

Build all PDFs (LuaLaTeX by default), plus other artifacts:

- `make -C cables build`

Build a single cable:

- `cables/.venv/bin/python cables/tools/build_cable.py --in cables/content/2025/12/20/mspm-cbl-2025-12-20-001.md`

Switch LaTeX engine (optional):

- Default engine is `pdflatex` (works with minimal TeX Live installs).
- `lualatex` / `xelatex` require a full TeX Live setup (font loader packages).

- `cables/.venv/bin/python cables/tools/build_cable.py --all --engine pdflatex`
- `cables/.venv/bin/python cables/tools/build_cable.py --all --engine xelatex`
- `cables/.venv/bin/python cables/tools/build_cable.py --all --engine lualatex`

## Outputs

- Per-cable PDF: `cables/build/pdf/<CABLE-ID>.pdf`
- Bulk PDFs: `cables/build/pdf/cables-all.zip`
- Per-day bulk PDFs: `cables/build/pdf/daily/YYYY-MM-DD.zip`
