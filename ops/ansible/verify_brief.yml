---
- name: Fetch latest manifest versions from origins
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    edge_global_origin: >-
      {{
        lookup('env', 'EDGE_GLOBAL_ORIGIN')
        | default(lookup('env', 'ORIGIN_BASE_URL'), true)
        | default(lookup('env', 'PUBLISH_ORIGIN_GLOBAL'), true)
        | default(lookup('env', 'ORIGIN_GLOBAL'), true)
      }}
    edge_do_origin: >-
      {{
        lookup('env', 'EDGE_ORIGIN_DO')
        | default(lookup('env', 'PUBLISH_ORIGIN_DO'), true)
        | default(lookup('env', 'DO_ORIGIN_BASE_URL'), true)
        | default(lookup('env', 'ORIGIN_DO'), true)
      }}
    edge_het_origin: >-
      {{
        lookup('env', 'EDGE_ORIGIN_HET')
        | default(lookup('env', 'PUBLISH_ORIGIN_HET'), true)
        | default(lookup('env', 'HET_ORIGIN_BASE_URL'), true)
        | default(lookup('env', 'ORIGIN_HET'), true)
      }}

  tasks:
    - name: Ensure origin-scw is set
      ansible.builtin.assert:
        that:
          - edge_global_origin | length > 0
        fail_msg: "Origin-scw is empty; set PUBLISH_ORIGIN_SCW (or EDGE_ORIGIN_SCW / EDGE_GLOBAL_ORIGIN)."

    - name: Ensure origin-do is set
      ansible.builtin.assert:
        that:
          - edge_do_origin | length > 0
        fail_msg: "Origin-do is empty; set PUBLISH_ORIGIN_DO (or EDGE_ORIGIN_DO)."

    - name: Fetch global manifests/latest.json
      ansible.builtin.uri:
        url: "{{ edge_global_origin }}/manifests/latest.json"
        method: GET
        return_content: true
      register: global_manifest

    - name: Fetch origin-do manifests/latest.json
      ansible.builtin.uri:
        url: "{{ edge_do_origin }}/manifests/latest.json"
        method: GET
        return_content: true
      register: do_manifest

    - name: Fetch origin-het manifests/latest.json (optional)
      ansible.builtin.uri:
        url: "{{ edge_het_origin }}/manifests/latest.json"
        method: GET
        return_content: true
      register: het_manifest
      when: edge_het_origin | length > 0

    - name: Set manifest versions
      ansible.builtin.set_fact:
        mspmetro_global_version: "{{ (global_manifest.content | from_json).version }}"
        mspmetro_do_version: "{{ (do_manifest.content | from_json).version }}"

    - name: Set origin-het manifest version (optional)
      ansible.builtin.set_fact:
        mspmetro_het_version: "{{ (het_manifest.content | from_json).version }}"
      when: edge_het_origin | length > 0

    - name: Print versions
      ansible.builtin.debug:
        msg: >-
          {{
            [
              "global origin: %s (version=%s)" | format(edge_global_origin, mspmetro_global_version),
              "origin-do: %s (version=%s)" | format(edge_do_origin, mspmetro_do_version)
            ]
            + (
              (edge_het_origin | length > 0)
              | ternary(
                  ["origin-het: %s (version=%s)" | format(edge_het_origin, mspmetro_het_version)],
                  []
                )
            )
          }}

- name: Verify edge nodes are serving latest content
  hosts: mspmetro_edges
  become: true

  vars:
    mspmetro_brief_root: /var/www/mspmetro-brief
    mspmetro_brief_unit: cityfeed-puller-brief

  tasks:
    - name: Choose expected version for this edge
      ansible.builtin.set_fact:
        expected_versions: >-
          {{
            (
              (
                ('mspmetro_edge_us' in group_names)
                or ('mspmetro_edge_do' in group_names)
              )
              | ternary(
                  [hostvars['localhost'].mspmetro_do_version, hostvars['localhost'].mspmetro_global_version],
                  [hostvars['localhost'].mspmetro_global_version, hostvars['localhost'].mspmetro_do_version]
                )
            )
          }}

    - name: Ensure current symlink exists
      ansible.builtin.stat:
        path: "{{ mspmetro_brief_root }}/current"
      register: current_link

    - name: Assert current symlink exists
      ansible.builtin.assert:
        that:
          - current_link.stat.exists
        fail_msg: "Missing {{ mspmetro_brief_root }}/current; puller has not run successfully."

    - name: Read current symlink target
      ansible.builtin.command: "readlink -f {{ mspmetro_brief_root }}/current"
      register: current_target
      changed_when: false

    - name: Derive current version from symlink target
      ansible.builtin.set_fact:
        current_version: "{{ current_target.stdout.split('/')[-1] }}"

    - name: Assert current matches expected version
      ansible.builtin.assert:
        that:
          - expected_versions | length > 0
          - current_version in expected_versions
        fail_msg: "current={{ current_target.stdout }} current_version={{ current_version }} expected_versions={{ expected_versions }}"

    - name: Verify key files exist
      ansible.builtin.command: "test -f {{ mspmetro_brief_root }}/current/index.html -a -f {{ mspmetro_brief_root }}/current/static/css/daily.css -a -f {{ mspmetro_brief_root }}/current/static/Logo_SVG.svg -a -f {{ mspmetro_brief_root }}/current/static/favicon.png"
      changed_when: false

    - name: Verify new front page marker exists (PICKS)
      ansible.builtin.command: "rg -q \"\\bPICKS\\b\" {{ mspmetro_brief_root }}/current/index.html"
      changed_when: false

    - name: Verify CSS stability header exists
      ansible.builtin.command: "rg -q \"FONT & RENDER STABILITY\" {{ mspmetro_brief_root }}/current/static/css/daily.css"
      changed_when: false

    - name: Verify puller timer is enabled
      ansible.builtin.command: "systemctl is-enabled {{ mspmetro_brief_unit }}.timer"
      register: timer_enabled
      changed_when: false

    - name: Verify puller timer is active
      ansible.builtin.command: "systemctl is-active {{ mspmetro_brief_unit }}.timer"
      register: timer_active
      changed_when: false

    - name: Print edge status
      ansible.builtin.debug:
        msg:
          - "edge={{ inventory_hostname }} expected_versions={{ expected_versions }}"
          - "current={{ current_target.stdout }}"
          - "timer: enabled={{ timer_enabled.stdout }} active={{ timer_active.stdout }}"
