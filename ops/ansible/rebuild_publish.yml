---
# Rebuild + publish the briefing from the Source Box, then have edges pull it.
#
# Typical use (from repo root on the controller):
#   set -a; source .env; set +a
#   ANSIBLE_CONFIG=ops/ansible/ansible.cfg ansible-playbook ops/ansible/rebuild_publish.yml
#
# Options:
# - Skip repo sync (useful if the source box already has the latest code):
#     ... --extra-vars 'mspmetro_sync_repo=false'
# - Run ingestion before publishing:
#     ... --extra-vars 'mspmetro_run_ingest=true'
#
# NOTE: NO DOCKER. Uses systemd services on the source box and pullers on edges.

- name: Build edge puller binary (controller)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    repo_root: "{{ playbook_dir }}/../.."

  tasks:
    - name: Build cityfeed-puller (for edges)
      ansible.builtin.command: cargo build --release --bin cityfeed-puller
      args:
        chdir: "{{ repo_root }}"
      changed_when: true
      tags: ["edges", "build"]

- name: Sync repo + publish on source box (MinIO push + replication fanout)
  hosts: mspmetro_source_box
  become: true
  gather_facts: false

  vars:
    mspmetro_repo_dir: /opt/mspmetro/source-box/cityfeed_pull
    mspmetro_source_user: mspmetro
    mspmetro_source_group: mspmetro
    mspmetro_sync_repo: true
    mspmetro_run_ingest: false

  tasks:
    - name: Ensure repo directory exists
      ansible.builtin.file:
        path: "{{ mspmetro_repo_dir }}"
        state: directory
        owner: "{{ mspmetro_source_user }}"
        group: "{{ mspmetro_source_group }}"
        mode: "0755"
      tags: ["sync"]

    - name: Sync repo to source box
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../..//"
        dest: "{{ mspmetro_repo_dir }}/"
        delete: true
        rsync_opts:
          - "--exclude=.git/"
          - "--exclude=.env"
          - "--exclude=.env.*"
          - "--exclude=target/"
          - "--exclude=build/"
          - "--exclude=data/cache/"
          - "--exclude=backend/.venv/"
          - "--exclude=.venv/"
          - "--exclude=cables/.venv/"
          - "--exclude=.venv-publisher/"
          - "--exclude=**/__pycache__/"
          - "--exclude=*.pyc"
      when: mspmetro_sync_repo | bool
      tags: ["sync"]

    - name: Ensure cables build dir is writable (remove stale root-owned artifacts)
      ansible.builtin.file:
        path: "{{ mspmetro_repo_dir }}/cables/build"
        state: absent
      tags: ["sync"]

    - name: Ensure cables subtree ownership (publisher user)
      ansible.builtin.file:
        path: "{{ mspmetro_repo_dir }}/cables"
        state: directory
        owner: "{{ mspmetro_source_user }}"
        group: "{{ mspmetro_source_group }}"
        recurse: true
      tags: ["sync"]

    - name: Ensure ingestion service exists
      ansible.builtin.command: systemctl cat mspmetro-source-ingest.service
      changed_when: false
      when: mspmetro_run_ingest | bool
      tags: ["ingest"]

    - name: Run ingestion now (oneshot)
      ansible.builtin.systemd:
        name: mspmetro-source-ingest.service
        state: started
      when: mspmetro_run_ingest | bool
      tags: ["ingest"]

    - name: Ensure publish service exists
      ansible.builtin.command: systemctl cat mspmetro-source-publish.service
      changed_when: false
      tags: ["publish"]

    - name: Run publish now (oneshot)
      ansible.builtin.systemd:
        name: mspmetro-source-publish.service
        state: started
      tags: ["publish"]

    - name: Check publish result
      ansible.builtin.command: systemctl show -p Result -p ExecMainStatus mspmetro-source-publish.service
      register: publish_show
      changed_when: false
      tags: ["publish"]

    - name: Assert publish succeeded
      ansible.builtin.assert:
        that:
          - "'Result=success' in publish_show.stdout"
          - "'ExecMainStatus=0' in publish_show.stdout"
        fail_msg: "publish failed: {{ publish_show.stdout }}"
      tags: ["publish"]

- name: Verify origins and public pages (controller)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    repo_root: "{{ playbook_dir }}/../.."

  tasks:
    - name: Ensure DigitalOcean origin objects are public (ACL)
      ansible.builtin.command: make publicize-origin-do
      args:
        chdir: "{{ repo_root }}"
      changed_when: false
      tags: ["verify"]

    - name: Verify origins (manifests reachable)
      ansible.builtin.command: make verify-origins
      args:
        chdir: "{{ repo_root }}"
      changed_when: false
      tags: ["verify"]

    - name: Verify public websites (www/eur/us)
      ansible.builtin.command: make verify-public
      args:
        chdir: "{{ repo_root }}"
      changed_when: false
      tags: ["verify"]

- import_playbook: deploy_edges.yml
